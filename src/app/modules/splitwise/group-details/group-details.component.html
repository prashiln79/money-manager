<div class="group-details-container">
	<!-- Loading State -->
	<div *ngIf="isLoading" class="loading-state">
		<mat-spinner diameter="40"></mat-spinner>
		<p>Loading group details...</p>
	</div>

	<!-- Main Content -->
	<div *ngIf="!isLoading && group" class="main-content">
		<!-- Header -->
		<div class="header">
			<div class="header-content">
				<div class="header-navigation">
					<button mat-icon-button (click)="goBack()" class="back-btn !z-[999]" aria-label="Go back">
						<mat-icon (click)="goBack()">arrow_back</mat-icon>
					</button><span class="group-title">{{ group.name | titlecase }}</span>
					<button mat-icon-button [matMenuTriggerFor]="groupMenu" class="more-actions-btn" aria-label="More options">
						<mat-icon>more_vert</mat-icon>
					</button>
				</div>
				<div class="header-actions">
					<mat-menu #groupMenu="matMenu" class="group-menu">
						<button mat-menu-item (click)="openAddMemberDialog()" class="menu-item">
							<mat-icon>person_add</mat-icon>
							<span>Add Member</span>
						</button>
						<mat-divider></mat-divider>
						<button mat-menu-item (click)="deleteGroup()" *ngIf="canManageGroup()" class="delete-action">
							<mat-icon>delete</mat-icon>
							<span>Delete Group</span>
						</button>
					</mat-menu>
				</div>
			</div>
		</div>

		<!-- Group Stats -->
		<div class="stats-section">
			<mat-card class="stats-card">
				<div class="stats-grid">
					<div class="stat-item">
						<div class="stat-content" (click)="openAddMemberDialog()">
							<div class="stat-value">{{ getGroupMemberCount() }}</div>
							<div class="stat-label">Members</div>
						</div>
					</div>
					<div class="stat-item">
						<div class="stat-content">
							<div class="stat-value">{{ formatCurrency(getTotalBalance(), group.currency) }}</div>
							<div class="stat-label">Total Balance</div>
						</div>
					</div>
				</div>
			</mat-card>
		</div>

		<!-- Member Balances Section -->
		<div class="balances-section" *ngIf="showBalances">
			<mat-card class="balances-card">
				<mat-card-header>
					<mat-card-title>
						<mat-icon>account_balance_wallet</mat-icon>
						<span>Member Balances</span>
					</mat-card-title>
					<mat-card-subtitle>
						Who owes what to whom
					</mat-card-subtitle>
				</mat-card-header>
				<mat-card-content>
					<div class="balances-list">
						<div *ngFor="let balance of getMemberBalances()" class="balance-item" [class.current-user]="balance.userId === currentUser?.uid">
							<div class="balance-info">
								<div class="member-name">
									{{ balance.displayName }}
									<span *ngIf="balance.userId === currentUser?.uid" class="current-user-badge">(You)</span>
								</div>
								<div class="balance-details">
									<span class="paid">Paid: {{ formatCurrency(balance.totalPaid, group.currency) }}</span>
									<span class="owed">Owed: {{ formatCurrency(balance.totalOwed, group.currency) }}</span>
								</div>
							</div>
							<div class="net-balance" [class]="getBalanceColor(balance.netBalance)">
								{{ formatCurrency(balance.netBalance, group.currency) }}
								<span *ngIf="balance.userId === currentUser?.uid" class="status-indicator">
									{{ getCurrentUserStatus(balance.netBalance) }}
								</span>
							</div>
						</div>
					</div>
					
					<!-- Detailed Balance Breakdown -->
					<div class="detailed-balances" *ngIf="currentUser?.uid">
						<mat-expansion-panel>
							<mat-expansion-panel-header>
								<mat-panel-title>
									<mat-icon>account_tree</mat-icon>
									<span>Detailed Balance Breakdown</span>
								</mat-panel-title>
								<mat-panel-description>
									See who owes what to whom
								</mat-panel-description>
							</mat-expansion-panel-header>
							
							<div class="breakdown-list">
								<div *ngFor="let breakdown of getDetailedBalanceBreakdown(currentUser.uid)" class="breakdown-item" [class]="breakdown.type">
									<div class="breakdown-info">
										<mat-icon [class]="breakdown.type === 'owes' ? 'arrow_upward' : 'arrow_downward'">
											{{ breakdown.type === 'owes' ? 'arrow_upward' : 'arrow_downward' }}
										</mat-icon>
										<span class="breakdown-message">{{ breakdown.message }}</span>
									</div>
									<div class="breakdown-amount" [class]="breakdown.type">
										{{ formatCurrency(breakdown.amount, group.currency) }}
									</div>
								</div>
								
								<div *ngIf="getDetailedBalanceBreakdown(currentUser.uid).length === 0" class="no-breakdown">
									<mat-icon>check_circle</mat-icon>
									<span>All balances are settled!</span>
								</div>
							</div>
						</mat-expansion-panel>
					</div>
				</mat-card-content>
			</mat-card>
		</div>

		<!-- Settlement Suggestions -->
		<div class="settlement-suggestions" *ngIf="getSettlementSuggestions().length > 0">
			<mat-card class="suggestions-card">
				<mat-card-header>
					<mat-card-title>
						<mat-icon>swap_horiz</mat-icon>
						<span>Settlement Suggestions</span>
					</mat-card-title>
					<mat-card-subtitle>
						{{ getSettlementSubtitle() }}
					</mat-card-subtitle>
				</mat-card-header>
				<mat-card-content>
					<div class="suggestions-list">
						<div *ngFor="let suggestion of getSettlementSuggestions()" class="suggestion-item" [class]="suggestion.type">
							<div class="suggestion-info">
								<div class="suggestion-message">
									<span class="message-text">{{ getSettlementMessage(suggestion) }}</span>
									<span *ngIf="isSettlementPending(suggestion.fromUserId, suggestion.toUserId)" class="settlement-status pending">
										(Pending)
									</span>
									<span *ngIf="isSettlementCompleted(suggestion.fromUserId, suggestion.toUserId)" class="settlement-status completed">
										(Completed)
									</span>
								</div>
								<div class="settlement-parties">
									<span class="from-user">{{ suggestion.fromUserName }}</span>
									<mat-icon>arrow_forward</mat-icon>
									<span class="to-user">{{ suggestion.toUserName }}</span>
								</div>
								<div class="settlement-amount">
									{{ formatCurrency(suggestion.amount, suggestion.currency) }}
								</div>
							</div>
							<button 
								mat-raised-button 
								[color]="suggestion.type === 'you_owe' ? 'warn' : 'primary'" 
								size="small" 
								(click)="createSettlement(suggestion)"
								[disabled]="suggestion.type === 'others' || isSettlementPending(suggestion.fromUserId, suggestion.toUserId) || isSettlementCompleted(suggestion.fromUserId, suggestion.toUserId)">
								<mat-icon>{{ suggestion.type === 'you_owe' ? 'payment' : 'check' }}</mat-icon>
								<span *ngIf="isSettlementPending(suggestion.fromUserId, suggestion.toUserId)">Pending</span>
								<span *ngIf="isSettlementCompleted(suggestion.fromUserId, suggestion.toUserId)">Completed</span>
								<span *ngIf="!isSettlementPending(suggestion.fromUserId, suggestion.toUserId) && !isSettlementCompleted(suggestion.fromUserId, suggestion.toUserId)">
									{{ suggestion.type === 'you_owe' ? 'Pay' : 'Settle' }}
								</span>
							</button>
						</div>
					</div>
				</mat-card-content>
			</mat-card>
		</div>

		<!-- Transactions Section -->
		<div class="transactions-section">
			<mat-card class="transactions-card">
				<mat-card-header>
					<mat-card-title>
						<mat-icon>receipt</mat-icon>
						<span>Transactions ({{ getTransactionCount() }})</span>
					</mat-card-title>
					<mat-card-subtitle>
						Total: {{ formatCurrency(getTotalTransactionAmount(), group.currency) }}
					</mat-card-subtitle>
				</mat-card-header>
				<mat-card-content>
					<!-- Transactions List -->
					<div *ngIf="transactions.length > 0" class="transactions-list">
						<div *ngFor="let transaction of transactions" class="transaction-item simple">
							<div class="transaction-main">
								<div class="transaction-info">
									<div class="transaction-title">
										{{ getTransactionTitle(transaction) }}
									</div>
									<div class="transaction-meta">
										<span class="paid-by">Paid by {{ getTransactionCreatorName(transaction) }}</span>
										<span class="transaction-date">{{ formatDate(transaction.createdAt) }}</span>
									</div>
								</div>
								<div class="transaction-amount">
									{{ formatCurrency(transaction.totalAmount, transaction.currency) }}
								</div>
							</div>
							

						</div>
					</div>
					
					<!-- Empty State -->
					<div *ngIf="transactions.length === 0" class="empty-state">
						<mat-icon class="empty-icon">receipt</mat-icon>
						<p>No transactions yet</p>
						<button mat-raised-button color="primary" (click)="addTransaction()">
							<mat-icon>add</mat-icon>
							Add Transaction
						</button>
					</div>
				</mat-card-content>
			</mat-card>
		</div>

		<!-- Settlements Section -->
		<div class="settlements-section" *ngIf="settlements.length > 0">
			<mat-card class="settlements-card">
				<mat-card-header>
					<mat-card-title>
						<mat-icon>swap_horiz</mat-icon>
						<span>Settlements ({{ getSettlementCount() }})</span>
					</mat-card-title>
				</mat-card-header>
				<mat-card-content>
					<div class="settlements-list">
						<div *ngFor="let settlement of settlements" class="settlement-item">
							<div class="settlement-info">
								<div class="settlement-parties">
									<span class="from-user">{{ getMemberName(settlement.fromUserId) }}</span>
									<mat-icon>arrow_forward</mat-icon>
									<span class="to-user">{{ getMemberName(settlement.toUserId) }}</span>
								</div>
								<div class="settlement-amount">
									{{ formatCurrency(settlement.amount, settlement.currency) }}
								</div>
							</div>
							<div class="settlement-status">
								<mat-chip [color]="settlement.status === 'completed' ? 'success' : 'warning'" selected>
									{{ settlement.status === 'completed' ? 'Completed' : 'Pending' }}
								</mat-chip>
							</div>
						</div>
					</div>
				</mat-card-content>
			</mat-card>
		</div>
	</div>

	<!-- Error State -->
	<div *ngIf="!isLoading && !group" class="error-state">
		<mat-icon class="error-icon">error</mat-icon>
		<h3>Group Not Found</h3>
		<p>The group you're looking for doesn't exist or you don't have access to it.</p>
		<button mat-raised-button color="primary" (click)="goBack()">
			<mat-icon>arrow_back</mat-icon>
			Go Back
		</button>
	</div>
</div>
