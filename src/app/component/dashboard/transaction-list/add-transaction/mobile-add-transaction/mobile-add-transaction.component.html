<!-- Mobile Header -->
<div class="sticky top-0 z-20 bg-white dark:bg-gray-800 border-b border-gray-200 dark:border-gray-700 shadow-sm">
	<div class="flex items-center justify-between px-4 py-3">
		<h6 class="text-lg font-semibold text-gray-900 dark:text-gray-100">
			{{ dialogData?.id ? 'Edit' : 'Add' }} Transaction
		</h6>
		<div class="flex items-center gap-2">
			<!-- Add Button -->
			<button 
				mat-icon-button 
				color="primary" 
				(click)="onSubmit()" 
				[disabled]="transactionForm.invalid || isSubmitting" 
				matTooltip="Save Transaction" 
				class="w-10 h-10 !bg-primary"
			>
				<mat-icon class="text-white">
					{{ isSubmitting ? 'hourglass_empty' : 'check' }}
				</mat-icon>
			</button>

			<!-- Close Button -->
			<button 
				mat-icon-button 
				type="button" 
				(click)="onClose()" 
				matTooltip="Close" 
				class="text-gray-500 hover:text-gray-700 dark:text-gray-400 dark:hover:text-gray-200"
			>
				<mat-icon>close</mat-icon>
			</button>
		</div>
	</div>
</div>

<!-- Mobile Form Content -->
<div class="flex-1 overflow-y-auto bg-gray-50 dark:bg-gray-900">
	<div class="p-4 space-y-6">
		<form [formGroup]="transactionForm" (ngSubmit)="onSubmit()" (keydown.enter)="onSubmit()" class="space-y-6">
			
			<!-- Amount, Description, Category, and Date Field - Combined Card -->
			<div class="bg-white dark:bg-gray-800 rounded-lg p-4 shadow-sm space-y-4">
				<!-- Amount Field -->
				<div>
					<label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
						Amount *
					</label>
					<input 
						#amountInput
						type="number" 
						formControlName="amount" 
						placeholder="0.00" 
						step="0.01" 
						(input)="onAmountChange()"
						class="w-full text-2xl font-bold text-center py-3 px-4 border-0 bg-transparent focus:outline-none focus:ring-2 focus:ring-blue-500 rounded-lg"
					/>
					@if(getAmountError() && transactionForm.get('amount')?.touched) {
						<p class="text-red-500 text-sm mt-1">{{ getAmountError() }}</p>
					}
				</div>

				<!-- Description Field -->
				<div>
					<label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
						Description *
					</label>
					<input 
						type="text" 
						formControlName="payee" 
						[maxlength]="45" 
						placeholder="Enter description" 
						class="w-full py-3 px-4 border border-gray-300 dark:border-gray-600 rounded-lg bg-transparent focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent"
					/>
					<div class="flex justify-between items-center mt-1">
						@if(transactionForm.get('payee')?.hasError('required') && transactionForm.get('payee')?.touched) {
							<p class="text-red-500 text-sm">Description is required</p>
						}
						<span class="text-xs text-gray-500">
							{{ transactionForm.get('payee')?.value?.length || 0 }}/45
						</span>
					</div>
				</div>

				<!-- Category Field -->
				<div>
					<div class="flex items-center justify-between mb-2">
						<label class="block text-sm font-medium text-gray-700 dark:text-gray-300">
							Category
						</label>
						<button 
							type="button"
							(click)="openNewCategoryDialog()"
							class="text-xs text-blue-600 dark:text-blue-400 hover:text-blue-800 dark:hover:text-blue-300 font-medium flex items-center gap-1"
						>
							<mat-icon class="text-sm">add</mat-icon>Add
						</button>
					</div>
					<mat-form-field appearance="fill" class="w-full">
						<mat-label>Select a category</mat-label>
						<mat-select formControlName="categoryId" (selectionChange)="onCategoryChange($event.value)">
							@for (item of categoryList$ | async; track item) {
								<mat-option [value]="item.id">{{ item?.name }}</mat-option>
							}
						</mat-select>
					</mat-form-field>
				</div>

				<!-- Date Field -->
				<div>
					<label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
						Date *
					</label>
					<div class="relative">
						<input 
							type="date" 
							formControlName="date" 
							class="w-full py-3 px-4 pr-10 border border-gray-300 dark:border-gray-600 rounded-lg bg-transparent focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent [&::-webkit-calendar-picker-indicator]:bg-none [&::-webkit-calendar-picker-indicator]:bg-transparent [&::-webkit-calendar-picker-indicator]:opacity-0 [&::-webkit-calendar-picker-indicator]:absolute [&::-webkit-calendar-picker-indicator]:right-0 [&::-webkit-calendar-picker-indicator]:top-0 [&::-webkit-calendar-picker-indicator]:w-full [&::-webkit-calendar-picker-indicator]:h-full [&::-webkit-calendar-picker-indicator]:cursor-pointer"
						/>
						<mat-icon class="absolute right-3 top-1/2 transform -translate-y-1/2 text-gray-400 pointer-events-none">
							calendar_today
						</mat-icon>
					</div>
					@if(getDateError()) {
						<p class="text-red-500 text-sm mt-1">{{ getDateError() }}</p>
					}
				</div>
			</div>

			<!-- Account Field -->
			<div class="bg-white dark:bg-gray-800 rounded-lg p-4 shadow-sm">
				<div class="flex items-center justify-between mb-2">
					<label class="block text-sm font-medium text-gray-700 dark:text-gray-300">
						Account *
					</label>
					<!-- @if(transactionForm.get('accountId')?.value) {
						@for (account of accountList; track account.accountId) {
							@if(account.accountId === transactionForm.get('accountId')?.value) {
								<button 
									matSuffix 
									mat-icon-button 
									type="button"
									(click)="openEditAccountDialog(account)"
									matTooltip="Edit {{ account.name }}"
									class="text-gray-500 hover:text-gray-700 dark:text-gray-400 dark:hover:text-gray-200"
								>
									<mat-icon class="text-sm">edit</mat-icon>
								</button>
							}
						}
					} -->
					<button 
						type="button"
						(click)="openNewAccountDialog()"
						class="text-xs text-blue-600 dark:text-blue-400 hover:text-blue-800 dark:hover:text-blue-300 font-medium flex items-center gap-1"
					>
						<mat-icon class="text-sm">add</mat-icon>
						Add
					</button>
					
				</div>
				
				<div class="space-y-2">
					<mat-form-field appearance="fill" class="w-full">
						<mat-label>Select an account</mat-label>
						<mat-select formControlName="accountId">
							@for (account of accountList$ | async; track account.accountId) {
								<mat-option [value]="account.accountId">{{ account.name }} ({{ account.type | titlecase }})</mat-option>
							}
						</mat-select>
						
						@if(transactionForm.get('accountId')?.hasError('required') && transactionForm.get('accountId')?.touched) {
							<mat-error>Account is required</mat-error>
						}
					</mat-form-field>
					
				</div>
			</div>

			<!-- Payment Method Field -->
			<div class="bg-white dark:bg-gray-800 rounded-lg p-4 shadow-sm" *ngIf="this.transactionForm.get('type')?.value === TransactionType.EXPENSE">
				<label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
					Payment Method
				</label>
				<mat-form-field appearance="fill" class="w-full">
					<mat-label>Select payment method</mat-label>
					<mat-select formControlName="paymentMethod">
						<mat-option value="">None</mat-option>
						@for (method of paymentMethods; track method.value) {
							<mat-option [value]="method.value">
								<div class="flex items-center gap-2">
									<mat-icon class="text-sm">{{ method.icon }}</mat-icon>
									<span>{{ method.label }}</span>
								</div>
							</mat-option>
						}
					</mat-select>
				</mat-form-field>
			</div>

			<!-- Notes Field -->
			<div class="bg-white dark:bg-gray-800 rounded-lg p-4 shadow-sm">
				<label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
					Notes
				</label>
				<textarea 
					formControlName="description" 
					[rows]="3" 
					placeholder="Add any additional notes..." 
					class="w-full py-3 px-4 border border-gray-300 dark:border-gray-600 rounded-lg bg-transparent focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent resize-none"
				></textarea>
			</div>

			<!-- Split Transaction Section -->
			<div class="bg-white dark:bg-gray-800 rounded-lg p-4 shadow-sm">
				<div class="flex items-center justify-between mb-4">
					<label class="block text-sm font-medium text-gray-700 dark:text-gray-300">
						Split with Group
					</label>

					<mat-slide-toggle formControlName="isSplitTransaction" (change)="toggleSplitTransaction()"></mat-slide-toggle>
					<!-- <button 
						type="button"
						(click)="toggleSplitTransaction()"
						class="flex items-center gap-2 px-3 py-2 text-sm font-medium rounded-lg transition-colors duration-200"
						[class]="isSplitTransaction ? 'bg-blue-100 text-blue-700 dark:bg-blue-900 dark:text-blue-300' : 'bg-gray-100 text-gray-700 dark:bg-gray-700 dark:text-gray-300'"
					>
						<mat-icon class="text-sm">{{ isSplitTransaction ? 'check_circle' : 'radio_button_unchecked' }}</mat-icon>
						{{ isSplitTransaction ? 'Split Enabled' : 'Split Disabled' }}
					</button> -->
				</div>

				<!-- Split Transaction Options -->
				@if(transactionForm.get('isSplitTransaction')?.value) {
					<div class="space-y-4">
						<!-- Group Selection -->
						<div>
							<label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
								Select Group *
							</label>
							<mat-form-field appearance="fill" class="w-full">
								<mat-label>Choose a group to split with</mat-label>
								<mat-select formControlName="splitGroupId">
									@for (group of groups$ | async; track group.id) {
										<mat-option [value]="group.id">
											<div class="flex items-center justify-between w-full">
												<span>{{ group.name }}</span>
												<span class="text-xs text-gray-500">{{ group.members.length }} members</span>
											</div>
										</mat-option>
									}
								</mat-select>
								<!-- @if(groups.length === 0) {
									<mat-hint class="text-orange-600">
										No groups available. 
										<button 
											type="button"
											(click)="openSplitwise()"
											class="text-blue-600 hover:text-blue-800 underline"
										>
											Create a group
										</button>
									</mat-hint>
								} -->
								@if(transactionForm.get('splitGroupId')?.hasError('required') && transactionForm.get('splitGroupId')?.touched) {
									<mat-error>Please select a group for split transaction</mat-error>
								}
							</mat-form-field>
						</div>

						<!-- Split Info -->
						<!-- @if(transactionForm.get('splitGroupId')?.value) {
							<div class="bg-blue-50 dark:bg-blue-900/20 rounded-lg p-3">
								<div class="flex items-center gap-2 mb-2">
									<mat-icon class="text-sm text-blue-600 dark:text-blue-400">info</mat-icon>
									<span class="text-sm font-medium text-blue-800 dark:text-blue-200">Split Details</span>
								</div>
								<div class="text-sm text-blue-700 dark:text-blue-300 space-y-1">
									<p>• Amount will be split equally among {{ selectedGroup.members.length }} members</p>
									<p>• Each member will owe ₹{{ ((transactionForm.get('amount')?.value || 0) / selectedGroup.members.length).toFixed(2) }}</p>
									<p>• You will be marked as the payer</p>
									<p>• A regular transaction will also be created in your account</p>
								</div>
							</div>
						} -->
					</div>
				}
			</div>

			<!-- Recurring Transaction Section -->
			<div class="bg-white dark:bg-gray-800 rounded-lg p-4 shadow-sm">
				<div class="flex items-center justify-between mb-4">
					<label class="block text-sm font-medium text-gray-700 dark:text-gray-300">
						Recurring Transaction
					</label>
					<mat-slide-toggle formControlName="isRecurring"></mat-slide-toggle>
				</div>

				<!-- Recurring Transaction Options -->
				@if(transactionForm.get('isRecurring')?.value) {
					<div class="space-y-4">
						<!-- Recurring Interval -->
						<div>
							<label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
								Repeat Every
							</label>
							<mat-form-field appearance="fill" class="w-full">
								<mat-label>Select interval</mat-label>
								<mat-select formControlName="recurringInterval">
									<mat-option [value]="'daily'">Daily</mat-option>
									<mat-option [value]="'weekly'">Weekly</mat-option>
									<mat-option [value]="'monthly'">Monthly</mat-option>
									<mat-option [value]="'yearly'">Yearly</mat-option>
								</mat-select>
							</mat-form-field>
						</div>

						<!-- Start Date -->
						<div>
							<label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
								Start Date
							</label>
							<input 
								type="date" 
								formControlName="recurringStartDate"
								[min]="recurringMinDate"
								[max]="recurringMaxDate"
								class="w-full py-3 px-4 border border-gray-300 dark:border-gray-600 rounded-lg bg-transparent focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent"
							/>
						</div>

						<!-- End Date -->
						<div>
							<label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
								End Date (Optional)
							</label>
							<input 
								type="date" 
								formControlName="recurringEndDate"
								[min]="recurringMinDate"
								[max]="recurringMaxDate"
								class="w-full py-3 px-4 border border-gray-300 dark:border-gray-600 rounded-lg bg-transparent focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent"
							/>
							<p class="text-xs text-gray-500 mt-1">Leave empty for unlimited recurrence</p>
						</div>

						<!-- Recurring Info -->
						<div class="bg-blue-50 dark:bg-blue-900/20 rounded-lg p-3">
							<div class="flex items-center gap-2 mb-2">
								<mat-icon class="text-sm text-blue-600 dark:text-blue-400">info</mat-icon>
								<span class="text-sm font-medium text-blue-800 dark:text-blue-200">Recurring Details</span>
							</div>
							<div class="text-sm text-blue-700 dark:text-blue-300 space-y-1">
								<p>• Transaction will repeat {{ transactionForm.get('recurringInterval')?.value || 'monthly' }}</p>
								<p>• Starting from {{ transactionForm.get('recurringStartDate')?.value || 'today' }}</p>
								@if(transactionForm.get('recurringEndDate')?.value) {
									<p>• Until {{ transactionForm.get('recurringEndDate')?.value }}</p>
								}
								<p>• You'll be notified when each occurrence is due</p>
							</div>
						</div>
					</div>
				}
			</div>

			<!-- Tax Fields -->
			<mat-expansion-panel class="bg-white dark:bg-gray-800 shadow-sm border-0">
				<mat-expansion-panel-header class="px-4 py-3">
					<mat-panel-title class="flex items-center gap-2">
						<mat-icon class="text-sm text-gray-600 dark:text-gray-400">receipt</mat-icon>
						<span class="text-sm font-medium text-gray-700 dark:text-gray-300">
							Tax Information (Optional)
						</span>
						@if((transactionForm.get('taxAmount')?.value || 0) > 0 || (transactionForm.get('taxPercentage')?.value || 0) > 0) {
							<span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium bg-blue-100 text-blue-800 dark:bg-blue-900 dark:text-blue-200">
								₹{{ (transactionForm.get('taxAmount')?.value || 0).toFixed(2) }}
							</span>
						}
					</mat-panel-title>
				</mat-expansion-panel-header>

				<div class="space-y-4 px-4 pb-4">
				
				<!-- Total Amount Display -->
				@if((transactionForm.get('amount')?.value || 0) > 0) {
					<div class="bg-gray-50 dark:bg-gray-700 rounded-lg p-3">
						<div class="flex justify-between items-center text-sm">
							<span class="text-gray-600 dark:text-gray-300">Transaction Amount:</span>
							<span class="font-medium text-gray-900 dark:text-gray-100">
								₹{{ (transactionForm.get('amount')?.value || 0).toFixed(2) }}
							</span>
						</div>
						@if((transactionForm.get('taxAmount')?.value || 0) > 0) {
							<div class="flex justify-between items-center text-sm mt-1">
								<span class="text-gray-600 dark:text-gray-300">Tax Amount:</span>
								<span class="font-medium text-red-600 dark:text-red-400">
									+₹{{ (transactionForm.get('taxAmount')?.value || 0).toFixed(2) }}
								</span>
							</div>
							<div class="flex justify-between items-center text-sm mt-2 pt-2 border-t border-gray-200 dark:border-gray-600">
								<span class="font-medium text-gray-700 dark:text-gray-300">Total Amount:</span>
								<span class="font-bold text-green-600 dark:text-green-400">
									₹{{ ((transactionForm.get('amount')?.value || 0) + (transactionForm.get('taxAmount')?.value || 0)).toFixed(2) }}
								</span>
							</div>
						}
					</div>
				}
				
				<!-- Tax Amount Field -->
				<div>
					<label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
						Tax Amount
					</label>
					<input 
						type="number" 
						formControlName="taxAmount" 
						placeholder="0.00" 
						step="0.01" 
						(input)="onTaxAmountChange()"
						class="w-full py-3 px-4 border border-gray-300 dark:border-gray-600 rounded-lg bg-transparent focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent"
					/>
					@if(transactionForm.get('taxAmount')?.hasError('min') && transactionForm.get('taxAmount')?.touched) {
						<p class="text-red-500 text-sm mt-1">Tax amount cannot be negative</p>
					}
				</div>

				<!-- Tax Percentage Field -->
				<div>
					<label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
						Tax Percentage (%)
					</label>
					<input 
						type="number" 
						formControlName="taxPercentage" 
						placeholder="0" 
						step="0.01" 
						min="0" 
						max="100"
						(input)="onTaxPercentageChange()"
						class="w-full py-3 px-4 border border-gray-300 dark:border-gray-600 rounded-lg bg-transparent focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent"
					/>
					<div class="flex justify-between items-center mt-1">
						@if(transactionForm.get('taxPercentage')?.hasError('min') && transactionForm.get('taxPercentage')?.touched) {
							<p class="text-red-500 text-sm">Tax percentage cannot be negative</p>
						}
						@if(transactionForm.get('taxPercentage')?.hasError('max') && transactionForm.get('taxPercentage')?.touched) {
							<p class="text-red-500 text-sm">Tax percentage cannot exceed 100%</p>
						}
						<span class="text-xs text-gray-500">
							{{ transactionForm.get('taxPercentage')?.value || 0 }}%
						</span>
					</div>
				</div>

				<!-- Clear Tax Button -->
				@if((transactionForm.get('taxAmount')?.value || 0) > 0 || (transactionForm.get('taxPercentage')?.value || 0) > 0) {
					<div class="pt-2">
						<button 
							type="button"
							(click)="clearTaxFields()"
							class="w-full py-2 px-4 text-sm text-gray-600 dark:text-gray-400 hover:text-gray-800 dark:hover:text-gray-200 border border-gray-300 dark:border-gray-600 rounded-lg hover:bg-gray-50 dark:hover:bg-gray-700 transition-colors duration-200"
						>
							<mat-icon class="text-sm mr-2">clear</mat-icon>
							Clear Tax Fields
						</button>
					</div>
				}
				</div>
			</mat-expansion-panel>

			<!-- Bottom Spacing for Mobile -->
			<div class="h-20"></div>
		</form>
	</div>
</div> 