<div class="categories-container">
	<!-- Error Message Display -->
	<div *ngIf="errorMessage" class="error-message mb-4 p-3 bg-red-50 border border-red-200 rounded-lg flex items-center justify-between">
		<p class="text-red-700 text-sm">{{ errorMessage }}</p>
		<button mat-icon-button (click)="clearError()" class="error-close-button">
			<mat-icon>close</mat-icon>
		</button>
	</div>

	<button mat-fab color="primary" *ngIf="isMobile && !home" (click)="openAddMobileDialog()" class="add-category-btn z-[100]">
		<mat-icon>add</mat-icon>
	</button>

	<div class="fab-button" *ngIf="!isMobile">
		<button mat-fab color="primary" (click)="openAddMobileDialog()" class="desktop-fab-btn">
			<mat-icon>add</mat-icon>
		</button>
	</div>

	<!-- Main Content -->
	<div class="categories-grid">
		<!-- Categories List Section -->
		<section class="categories-list">
			<div class="section-header" *ngIf="!home">
				<div class="header-content">
					<h2 class="section-title">Manage Categories</h2>
					<p class="section-subtitle">({{ categories.length }} categor{{ categories.length !== 1 ? 'ies' : 'y' }})</p>
				</div>
			</div>

			<!-- Empty State -->
			<div *ngIf="categories && categories.length === 0 && !home" class="empty-state">
				<div class="empty-icon">
					<mat-icon>local_offer</mat-icon>
				</div>
				<h3 class="empty-title">No categories yet</h3>
				<p class="empty-text">Add your first category to get started</p>
				<button *ngIf="isMobile" mat-raised-button color="primary" (click)="openAddMobileDialog()" class="empty-state-button">
					<mat-icon>add</mat-icon>
					Add Category
				</button>
			</div>

			<!-- Categories List -->
			<div *ngIf="categories.length > 0" class="categories-grid-list">
				<!-- Overall Budget Card -->
				<div class="budget-summary-card" *ngIf="getOverallBudgetStats().categoriesWithBudget > 0" [class.expanded]="isBudgetSummaryExpanded">
					<div class="budget-summary-header">
						<mat-icon class="budget-icon">account_balance_wallet</mat-icon>
						<h3 class="budget-summary-title">Overall Monthly Budget</h3>
					</div>
					
					<div class="budget-summary-stats">
						<div class="budget-stat-item">
							<span class="budget-stat-label">Total Budget:</span>
							<span class="budget-stat-value">{{ getOverallBudgetStats().totalBudget | currency }}</span>
						</div>
						
						<!-- <div class="budget-stat-item">
							<span class="budget-stat-label">Spent:</span>
							<span class="budget-stat-value spent">{{ getOverallBudgetStats().totalSpent | currency }}</span>
						</div> -->
						
						<!-- <div class="budget-stat-item">
							<span class="budget-stat-label">Remaining:</span>
							<span class="budget-stat-value" [class]="getOverallBudgetStatusClass()">
								{{ getOverallBudgetStats().totalRemaining | currency }}
							</span>
						</div> -->
						
						
					</div>
					
					<!-- Overall Budget Progress Bar -->
					<div class="overall-budget-progress">
						<div class="progress-bar">
							<div class="progress-fill" 
								 [style.width.%]="Math.min(getOverallBudgetStats().overallProgress, 100)" 
								 [style.background-color]="getOverallBudgetProgressColor()">
							</div>
						</div>
						<div class="progress-text">
							{{ getOverallBudgetStats().totalSpent | currency }} / {{ getOverallBudgetStats().totalBudget | currency }} ({{ getOverallBudgetStats().overallProgress.toFixed(1) }}%)
						</div>
					</div>
<!-- 					
					<div class="budget-summary-footer">
						<span class="budget-categories-count">
							{{ getOverallBudgetStats().categoriesWithBudget }} categor{{ getOverallBudgetStats().categoriesWithBudget !== 1 ? 'ies' : 'y' }} with budget
						</span>
					</div> -->

					<!-- Expand/Collapse Button -->
					<div class="expand-section">
						<button mat-button (click)="toggleBudgetSummaryExpansion()" class="expand-btn">
							<mat-icon>{{ isBudgetSummaryExpanded ? 'expand_less' : 'expand_more' }}</mat-icon>
							<span>{{ isBudgetSummaryExpanded ? 'Show Less' : 'Show More' }}</span>
						</button>
					</div>

					<!-- Expanded Details -->
					<div *ngIf="isBudgetSummaryExpanded" class="budget-details-expanded">
						<mat-tab-group class="details-tabs">
							<!-- Summary Tab -->
							<mat-tab label="Summary">
								<div class="tab-content">
									<div class="detail-row">
										<span class="detail-label">Total Categories with Budget:</span>
										<span class="detail-value">{{ getDetailedBudgetStats().totalCategories }}</span>
									</div>
									<div class="detail-row">
										<span class="detail-label">Average Budget per Category:</span>
										<span class="detail-value">{{ getOverallBudgetStats().averageBudget | currency }}</span>
									</div>
									<div class="detail-row">
										<span class="detail-label">Average Spent per Category:</span>
										<span class="detail-value">{{ getDetailedBudgetStats().averageSpentPerCategory | currency }}</span>
									</div>
									<div class="detail-row" *ngIf="getDetailedBudgetStats().mostExpensiveCategory">
										<span class="detail-label">Highest Spending Category:</span>
										<span class="detail-value">
											<mat-icon [style.color]="getDetailedBudgetStats().mostExpensiveCategory.color">{{ getDetailedBudgetStats().mostExpensiveCategory.icon }}</mat-icon>
											{{ getDetailedBudgetStats().mostExpensiveCategory.name }} ({{ getDetailedBudgetStats().mostExpensiveCategory.spent | currency }})
										</span>
									</div>
									<div class="detail-row" *ngIf="getDetailedBudgetStats().leastExpensiveCategory">
										<span class="detail-label">Lowest Spending Category:</span>
										<span class="detail-value">
											<mat-icon [style.color]="getDetailedBudgetStats().leastExpensiveCategory.color">{{ getDetailedBudgetStats().leastExpensiveCategory.icon }}</mat-icon>
											{{ getDetailedBudgetStats().leastExpensiveCategory.name }} ({{ getDetailedBudgetStats().leastExpensiveCategory.spent | currency }})
										</span>
									</div>
								</div>
							</mat-tab>

							<!-- Category Breakdown Tab -->
							<mat-tab label="Category Breakdown">
								<div class="tab-content">
									<div class="category-breakdown-list">
										<div class="category-breakdown-item" *ngFor="let cat of getDetailedBudgetStats().categories">
											<div class="category-breakdown-header">
												<mat-icon [style.color]="cat.color">{{ cat.icon }}</mat-icon>
												<span class="category-name">{{ cat.name }}</span>
											</div>
											<div class="category-breakdown-stats">
												<div class="breakdown-stat">
													<span class="breakdown-label">Budget:</span>
													<span class="breakdown-value">{{ cat.budget | currency }}</span>
												</div>
												<div class="breakdown-stat">
													<span class="breakdown-label">Spent:</span>
													<span class="breakdown-value spent">{{ cat.spent | currency }}</span>
												</div>
												<div class="breakdown-stat">
													<span class="breakdown-label">Remaining:</span>
													<span class="breakdown-value" [class]="cat.remaining < 0 ? 'danger' : 'safe'">
														{{ cat.remaining | currency }}
													</span>
												</div>
												<div class="breakdown-stat">
													<span class="breakdown-label">Progress:</span>
													<span class="breakdown-value" [class]="cat.progress >= 90 ? 'danger' : cat.progress >= 75 ? 'warning' : 'safe'">
														{{ cat.progress.toFixed(1) }}%
													</span>
												</div>
											</div>
											<div class="category-breakdown-progress">
												<div class="progress-bar">
													<div class="progress-fill" 
														 [style.width.%]="Math.min(cat.progress, 100)" 
														 [style.background-color]="cat.progress >= 100 ? '#ef4444' : cat.progress >= 80 ? '#f59e0b' : cat.progress >= 60 ? '#3b82f6' : '#10b981'">
													</div>
												</div>
											</div>
										</div>
									</div>
								</div>
							</mat-tab>
						</mat-tab-group>
					</div>
				</div>

				<!-- No Budget Set Card -->
				<div class="no-budget-card" *ngIf="!home && getOverallBudgetStats().categoriesWithBudget === 0">
					<div class="no-budget-content">
						<mat-icon class="no-budget-icon">info</mat-icon>
						<div class="no-budget-text-content">
							<h4 class="no-budget-title">No Budgets Set</h4>
							<p class="no-budget-text">Set budgets for your expense categories to track your spending goals and get better insights.</p>
						</div>
					</div>
				</div>

				@if(!home){
					@for (category of categories; track category.id) {
					<div class="category-item" [style.border-left-color]="category.color" [class.expanded]="expandedCategory?.id === category.id">
						<div class="category-content">
							<div class="category-info">
								<div class="category-icon-name">
									<div class="category-icon-container">
										<mat-icon class="category-icon" [style.color]="category.color">{{ category.icon || 'category' }}</mat-icon>
									</div>
									<div class="category-details">
										<div class="category-header">
											<h3 class="category-name">{{ category.name }} <span class="text-[0.6rem] text-gray-400"> {{category.type | titlecase}}</span></h3>
										</div>

										<!-- Budget Information -->
										<div *ngIf="category?.budget?.hasBudget" class="budget-info">
											<div class="budget-amount">
												<span class="budget-label">Budget:</span>
												<span class="budget-value">{{ category.budget?.budgetAmount | currency }}</span>
												<span class="budget-period">/ {{ formatBudgetPeriod(category.budget?.budgetPeriod) }}</span>
											</div>

											<div class="budget-progress" *ngIf="category.budget?.budgetProgressPercentage !== undefined">
												<div class="progress-bar">
													<div class="progress-fill" [style.width.%]="Math.min(category.budget?.budgetProgressPercentage || 0, 100)" [style.background-color]="getBudgetProgressColor(category)"></div>
												</div>
												<span class="progress-text">
													{{ category.budget?.budgetSpent | currency }} ({{ (category.budget?.budgetProgressPercentage || 0).toFixed(1) }}%)
												</span>
											</div>
										</div>
										<div class="category-spent" *ngIf="!category?.budget?.hasBudget">
											<span class="category-spent-label">{{ category.type === 'expense' ? 'Spent:' : 'Income:' }}</span>
											<span class="category-spent-value">{{ category.type === 'expense' ? (calculateTotalSpentPerMonth(category) | currency) : (calculateTotalIncomePerMonth(category) | currency) }}</span>
											<span class="category-spent-period"> (Monthly) </span>
										</div>
										<!-- <div class="category-spent mt-[-10px]" >
											<span class="category-spent-label">Type:</span>
											<span class="category-spent-label font-semibold" >{{ category.type | titlecase }}</span>
										</div> -->
									</div>
								</div>
							</div>
							<div class="category-actions">
								<mat-menu #menu="matMenu">
									<button
										mat-menu-item
										(click)="openBudgetDialog(category)"
										class="action-button budget-button"
										matTooltip="Set budget"
									
										*ngIf="!home && category.type === 'expense'"
									>
										<mat-icon>account_balance_wallet</mat-icon> Set Budget
									</button>
									<button mat-menu-item  (click)="editCategory(category)" class="action-button edit-button" matTooltip="Edit category">
										<mat-icon>edit</mat-icon> Edit
									</button>
									<button mat-menu-item (click)="deleteCategory(category)" class="action-button delete-button" matTooltip="Delete category">
										<mat-icon>delete</mat-icon> Delete
									</button>
								</mat-menu>
								<!-- <span class="category-type" *ngIf="!category?.budget?.hasBudget">{{ category.type }}</span> -->
								<button matIconButton [matMenuTriggerFor]="menu">
									<mat-icon>more_vert</mat-icon>
								</button>
							</div>
						</div>

						<!-- Expand/Collapse Button -->
						<div class="expand-section" *ngIf="!isMobile">
							<button mat-button (click)="toggleCategoryExpansion(category)" class="expand-btn">
								<mat-icon>{{ expandedCategory?.id === category.id ? 'expand_less' : 'expand_more' }}</mat-icon>
								<span>{{ expandedCategory?.id === category.id ? 'Show Less' : 'Show More' }}</span>
							</button>
						</div>

						<!-- Expanded Details -->
						<div *ngIf="expandedCategory?.id === category.id" class="category-details-expanded">
							<mat-tab-group class="details-tabs">
								<!-- Basic Details Tab -->
								<mat-tab label="Basic Details">
									<div class="tab-content">
										<div class="detail-row">
											<span class="detail-label">Category Name:</span>
											<span class="detail-value">{{ category.name }}</span>
										</div>
										<div class="detail-row">
											<span class="detail-label">Category Type:</span>
											<span class="detail-value">{{ category.type | titlecase }}</span>
										</div>
										<div class="detail-row">
											<span class="detail-label">Icon:</span>
											<span class="detail-value">
												<mat-icon [style.color]="category.color">{{ category.icon || 'category' }}</mat-icon>
												{{ category.icon || 'category' }}
											</span>
										</div>
										<div class="detail-row">
											<span class="detail-label">Color:</span>
											<span class="detail-value">
												<div class="color-preview" [style.background-color]="category.color"></div>
												{{ category.color }}
											</span>
										</div>
									</div>
								</mat-tab>

								<!-- Budget Details Tab -->
								<mat-tab label="Budget Details" *ngIf="category?.budget?.hasBudget">
									<div class="tab-content">
										<div class="detail-row">
											<span class="detail-label">Budget Amount:</span>
											<span class="detail-value">{{ category.budget?.budgetAmount | currency }}</span>
										</div>
										<div class="detail-row">
											<span class="detail-label">Budget Period:</span>
											<span class="detail-value">{{ formatBudgetPeriod(category.budget?.budgetPeriod) }}</span>
										</div>
										<div class="detail-row">
											<span class="detail-label">Amount Spent:</span>
											<span class="detail-value" [class]="getBudgetStatusClass(category)">
												{{ category.budget?.budgetSpent | currency }}
											</span>
										</div>
										<div class="detail-row">
											<span class="detail-label">Remaining Budget:</span>
											<span class="detail-value" [class]="getRemainingBudgetClass(category)">
												{{ (category.budget?.budgetAmount || 0) - (category.budget?.budgetSpent || 0) | currency }}
											</span>
										</div>
										<div class="detail-row">
											<span class="detail-label">Progress Percentage:</span>
											<span class="detail-value" [class]="getBudgetStatusClass(category)">
												{{ (category.budget?.budgetProgressPercentage || 0).toFixed(1) }}%
											</span>
										</div>
										<div class="detail-row" *ngIf="category.budget?.budgetStartDate">
											<span class="detail-label">Budget Start Date:</span>
											<span class="detail-value">{{ dateService.toDate(category.budget?.budgetStartDate) | date:'shortDate' }}</span>
										</div>
										<div class="detail-row" *ngIf="category.budget?.budgetEndDate">
											<span class="detail-label">Budget End Date:</span>
											<span class="detail-value">{{ category.budget?.budgetEndDate }}</span>
										</div>
									</div>
								</mat-tab>

								<!-- No Budget Tab -->
								<mat-tab label="Budget Details" *ngIf="!category?.budget?.hasBudget">
									<div class="tab-content">
										<div class="no-budget-details">
											<mat-icon>account_balance_wallet</mat-icon>
											<h4>No Budget Set</h4>
											<p>This category doesn't have a budget configured yet.</p>
											<button mat-raised-button color="primary" (click)="openBudgetDialog(category)" *ngIf="category.type === 'expense'">
												<mat-icon>add</mat-icon>
												Set Budget
											</button>
										</div>
									</div>
								</mat-tab>

								<!-- Transaction History Tab -->
								<mat-tab label="Recent Transactions">
									<div class="tab-content">
										<div class="no-transactions" *ngIf="!getRecentTransactions(category)?.length">
											<mat-icon>receipt_long</mat-icon>
											<p>No recent transactions</p>
										</div>
										<div class="transaction-list" *ngIf="getRecentTransactions(category)?.length">
											<div class="transaction-item" *ngFor="let transaction of getRecentTransactions(category)">
												<div class="transaction-info">
													<span class="transaction-description">{{ transaction.payee }}</span>
													<span class="transaction-date">{{ dateService.toDate(transaction.date) | date:'shortDate' }}</span>
												</div>
												<span class="transaction-amount" [class]="transaction.amount >= 0 ? 'positive' : 'negative'">
													{{ transaction.amount | currency }}
												</span>
											</div>
										</div>
									</div>
								</mat-tab>

								<!-- Statistics Tab -->
								<mat-tab label="Statistics">
									<div class="tab-content">
										<div class="detail-row">
											<span class="detail-label">Total Transactions:</span>
											<span class="detail-value">{{ getCategoryStats(category)?.totalTransactions || 0 }}</span>
										</div>
										<div class="detail-row">
											<span class="detail-label">Total Spent:</span>
											<span class="detail-value negative">{{ getCategoryStats(category)?.totalSpent | currency }}</span>
										</div>
										<div class="detail-row">
											<span class="detail-label">Average Transaction:</span>
											<span class="detail-value">{{ getCategoryStats(category)?.averageTransaction | currency }}</span>
										</div>
										<div class="detail-row">
											<span class="detail-label">Largest Transaction:</span>
											<span class="detail-value negative">{{ getCategoryStats(category)?.largestTransaction | currency }}</span>
										</div>
										<div class="detail-row">
											<span class="detail-label">This Month:</span>
											<span class="detail-value negative">{{ getCategoryStats(category)?.thisMonth | currency }}</span>
										</div>
										<div class="detail-row">
											<span class="detail-label">Last Month:</span>
											<span class="detail-value negative">{{ getCategoryStats(category)?.lastMonth | currency }}</span>
										</div>
									</div>
								</mat-tab>
							</mat-tab-group>
						</div>
					</div>
					}
				}
			</div>
		</section>
	</div>
</div>

