<div class="categories-container">
	<!-- Error Message Display -->
	<div *ngIf="errorMessage" class="error-message mb-4 p-3 bg-red-50 border border-red-200 rounded-lg flex items-center justify-between">
		<p class="text-red-700 text-sm">{{ errorMessage }}</p>
		<button mat-icon-button (click)="clearError()" class="error-close-button">
			<mat-icon>close</mat-icon>
		</button>
	</div>

	<button
		mat-fab
		color="primary"
		*ngIf="(breakpointService.device.isMobile || breakpointService.device.isTablePortrait)"
		(click)="openAddMobileDialog()"
		class="mobile-fab-btn add-category-btn"
	>
		<mat-icon>add</mat-icon>
	</button>

	<button mat-fab color="primary" (click)="openAddMobileDialog()" class="desktop-fab-btn" *ngIf="!breakpointService.device.isMobile && !breakpointService.device.isTablePortrait">
		<mat-icon>add</mat-icon>
	</button>

	<!-- Main Content -->
	<div class="categories-grid" [ngClass]="{'px-10': !breakpointService.device.isMobile}">
		<!-- Categories List Section -->
		<section class="categories-list">
			<div class="section-header" >
				<div class="header-content">
					<h2 class="section-title">Manage Categories</h2>
					<span class="flex items-center gap-2">
						<p class="section-subtitle">({{ categories.length }} categor{{ categories.length !== 1 ? 'ies' : 'y' }})</p>
						<mat-icon (click)="toggleListViewMode()" [matTooltip]="isListViewMode ? 'Switch to detailed view' : 'Switch to list view'">{{ isListViewMode ? 'view_list' : 'list' }}</mat-icon>
					</span>
				</div>
			</div>

			<!-- Empty State -->
			<div *ngIf="categories && categories.length === 0" class="empty-state">
				<div class="empty-icon">
					<mat-icon>local_offer</mat-icon>
				</div>
				<h3 class="empty-title">No categories yet</h3>
				<p class="empty-text">Add your first category to get started</p>
				<button *ngIf="breakpointService.device.isMobile" mat-raised-button color="primary" (click)="openAddMobileDialog()" class="empty-state-button">
					<mat-icon>add</mat-icon>
					Add Category
				</button>
			</div>

			<!-- Categories List -->
			<div *ngIf="categories.length > 0" class="categories-grid-list" [ngClass]="{'!max-h-[100vh]': breakpointService.device.isTablePortrait, '!max-h-[75vh]': !isChildView}">
				<!-- Overall Budget Card -->
				<app-budget-card [isHomeView]="false" [isChildView]="isChildView"></app-budget-card>


				<!-- List View -->
				<div *ngIf="isListViewMode" class="list-view-container pt-4">
					@for (category of categories; track category.id) {
					<!-- Only show main categories (not sub-categories) in the main list -->
					@if(!category.isSubCategory && !category.parentCategoryId) {
					<div class="list-view-item" [style.border-left-color]="category.color">
						<div class="list-view-content">
							<mat-icon class="list-view-icon" [style.color]="category.color">{{ category.icon || 'category' }}</mat-icon>
							<span class="list-view-name">{{ category.name }}</span>
							<span class="list-view-type">{{ category.type | titlecase }}</span>
						</div>
						<div class="list-view-actions">
							<mat-menu #listMenu="matMenu">
								<button mat-menu-item (click)="openMobileDialog(category)" class="action-button edit-button"><mat-icon>edit</mat-icon> Edit</button>
								<button mat-menu-item (click)="deleteCategory(category)" class="action-button delete-button"><mat-icon class="!text-red-800">delete</mat-icon> Delete</button>
							</mat-menu>
							<button matIconButton [matMenuTriggerFor]="listMenu">
								<mat-icon>more_vert</mat-icon>
							</button>
						</div>
					</div>
					}

					<!-- Display sub-categories under their parent in list view -->
					@if(getSubCategoriesForCategory(category.id!).length > 0 && breakpointService.device.isMobile) {
					<div class="sub-category-list-wrapper">
						<div class="group-header">Sub-categories</div>
						@for (subCategory of getSubCategoriesForCategory(category.id!); track subCategory.id) {
						<div class="list-view-item sub-category-item" [style.border-left-color]="subCategory.color">
							<div class="list-view-content">
								<mat-icon class="list-view-icon" [style.color]="subCategory.color">{{ subCategory.icon || 'category' }}</mat-icon>
								<span class="list-view-name">{{ subCategory.name }}</span>
								<span class="list-view-type">{{ subCategory.type | titlecase }}</span>
							</div>
							<div class="list-view-actions">
								<mat-menu #subListMenu="matMenu">
									<button mat-menu-item (click)="openMobileDialog(subCategory)" class="action-button edit-button"><mat-icon>edit</mat-icon> Edit</button>
									<button mat-menu-item (click)="openMobileDialog(subCategory)" class="action-button delete-button"><mat-icon class="!text-red-800">delete</mat-icon> Delete</button>
								</mat-menu>
								<button matIconButton [matMenuTriggerFor]="subListMenu">
									<mat-icon>more_vert</mat-icon>
								</button>
							</div>
						</div>
						}
					</div>
					} } 
				</div>

				<!-- Detailed View -->
				<div *ngIf="!isListViewMode" class="grid lg:grid-cols-2 xxl:grid-cols-3 gap-4 lg:my-5 pt-4" [ngClass]="{'lg:grid-cols-4': !isChildView}">
					@for (category of categories; track category.id) {
					<!-- Only show main categories (not sub-categories) in the main list -->
					@if(!category.isSubCategory && !category.parentCategoryId) {
					<app-category-card
						[category]="category"
						[isMobile]="breakpointService.device.isMobile"
						[recentTransactions]="getRecentTransactions(category)"
						[categoryStats]="getCategoryStats(category)"
						[allTransactions]="transactions"
						[subCategories]="getSubCategoriesForCategory(category.id!)"
						[Math]="Math"
					>
					</app-category-card>
					}

					<!-- Display sub-categories under their parent -->
					@if(getSubCategoriesForCategory(category.id!).length > 0 && breakpointService.device.isMobile) {
					<div class="sub-category-wrapper">
						<div class="group-header">Sub-categories</div>
						<div class="sub-categories-container">
							@for (subCategory of getSubCategoriesForCategory(category.id!); track subCategory.id) {
							<app-category-card
								[category]="subCategory"
								[isMobile]="breakpointService.device.isMobile"
								[recentTransactions]="getRecentTransactions(subCategory)"
								[categoryStats]="getCategoryStats(subCategory)"
								[allTransactions]="transactions"
								[subCategories]="getSubCategoriesForCategory(category.id!)"
								[subCategoryCount]="0"
								[Math]="Math"
							>
							</app-category-card>
							}
						</div>
					</div>
					} } 
				</div>
			</div>
		</section>
	</div>
</div>
