<div class="accounts-container">
	<!-- Error Message Display -->
	<div *ngIf="errorMessage" class="error-message mb-4 p-3 bg-red-50 border border-red-200 rounded-lg flex items-center justify-between">
		<p class="text-red-700 text-sm">{{ errorMessage }}</p>
		<button mat-icon-button (click)="clearError()" class="error-close-button">
			<mat-icon>close</mat-icon>
		</button>
	</div>

	<button mat-fab color="primary" *ngIf="isMobile" (click)="addAccount()" class="add-account-btn z-[100]">
		<mat-icon>add</mat-icon>
	</button>

	<div class="fab-button" *ngIf="!isMobile">
		<button mat-fab color="primary" (click)="addAccount()" class="desktop-fab-btn">
			<mat-icon>add</mat-icon>
		</button>
	</div>

	<!-- Main Content -->
	<div class="accounts-grid">
		<!-- Accounts List Section -->
		<section class="accounts-list">
			<div class="section-header" *ngIf="!home">
				<div class="header-content">
					<h2 class="section-title">Manage Accounts</h2>
					<p class="section-subtitle">({{ (accounts$ | async)?.length || 0 }} account{{ ((accounts$ | async)?.length || 0) !== 1 ? 's' : '' }})</p>
				</div>
			</div>

			<!-- Total Balance Summary Card -->
			<div class="balance-summary-card" [ngClass]="{'mt-[-12px] m-1': home}" *ngIf="((accounts$ | async)?.length ?? 0) > 0">
				<div class="balance-summary-header">
					<mat-icon class="balance-icon">account_balance</mat-icon>
					<h3 class="balance-summary-title">Total Balance</h3>
				</div>
				
				<div class="balance-summary-stats">
					<div class="balance-stat-item">
						<span class="balance-stat-label">Net Worth:</span>
						<span class="balance-stat-value" [class]="((totalBalance$ | async) ?? 0) >= 0 ? 'positive' : 'negative'">
							{{ (totalBalance$ | async) ?? 0 | currency }}
						</span>
					</div>
				</div>
				
				<!-- Balance Breakdown -->
				<div class="balance-breakdown">
					<div class="breakdown-item positive" *ngIf="getPositiveAccounts()?.length">
						<span class="breakdown-label">Assets:</span>
						<span class="breakdown-value">{{ getTotalPositiveBalance() | currency }}</span>
					</div>
					<div class="breakdown-item negative" *ngIf="getNegativeAccounts()?.length">
						<span class="breakdown-label">Liabilities:</span>
						<span class="breakdown-value">{{ getTotalNegativeBalance() | currency }}</span>
					</div>
				</div>
			</div>

			<!-- Empty State -->
			<div *ngIf="(accounts$ | async)?.length === 0 && !home" class="empty-state">
				<div class="empty-icon">
					<mat-icon>account_balance</mat-icon>
				</div>
				<h3 class="empty-title">No accounts yet</h3>
				<p class="empty-text">Add your first account to get started</p>
				<button *ngIf="isMobile" mat-raised-button color="primary" (click)="addAccount()" class="empty-state-button">
					<mat-icon>add</mat-icon>
					Add Account
				</button>
			</div>

			<!-- Accounts List -->
			<div *ngIf="!home && (accounts$ | async) as accounts" class="accounts-grid-list">
				@for (account of accounts; track account.accountId) {
				<div class="account-item" [class]="getBalanceClass(account)" [class.expanded]="expandedAccount?.accountId === account.accountId">
					<div class="account-content">
						<div class="account-info">
							<div class="account-icon-name">
								<div class="account-icon-container">
									<mat-icon class="account-icon">{{ getAccountIcon(account.type) }}</mat-icon>
								</div>
								<div class="account-details">
									<div class="account-header">
										<h3 class="account-name">{{ account.name | titlecase }}</h3>
									</div>

									<!-- Account Type Information -->
									<div class="account-type-info">
										@if(isLoanAccount(account)){
											<div class="loan-info">
												<span class="loan-label">Loan Interest Rate:</span>
												<span class="loan-value">{{ getLoanDetails(account)?.interestRate }}%</span>
											</div>
										}@else{
											<span class="account-type">{{ account.type | titlecase }}</span>
										}
									</div>

									<!-- Balance Information -->
									<div class="account-balance-info">
										<span class="balance-label">Balance:</span>
										<span class="balance-value" [class]="account.balance >= 0 ? 'positive' : 'negative'">
											{{ isLoanAccount(account) ? (getLoanDetails(account)?.remainingBalance | currency) : account.balance | currency }}
										</span>
									</div>
								</div>
							</div>
						</div>
						<div class="account-actions">
							<mat-menu #menu="matMenu">
								<button mat-menu-item (click)="editAccount(account)" class="action-button edit-button" matTooltip="Edit account">
									<mat-icon>edit</mat-icon> Edit
								</button>
								<button mat-menu-item (click)="deleteAccount(account)" class="action-button delete-button" matTooltip="Delete account">
									<mat-icon>delete</mat-icon> Delete
								</button>
							</mat-menu>
							<button matIconButton [matMenuTriggerFor]="menu">
								<mat-icon>more_vert</mat-icon>
							</button>
						</div>
					</div>

					<!-- Expand/Collapse Button -->
					<div class="expand-section">
						<button mat-button (click)="toggleAccountExpansion(account)" class="expand-btn">
							<mat-icon>{{ expandedAccount?.accountId === account.accountId ? 'expand_less' : 'expand_more' }}</mat-icon>
							<span>{{ expandedAccount?.accountId === account.accountId ? 'Show Less' : 'Show More' }}</span>
						</button>
					</div>

					<!-- Expanded Details -->
					<div *ngIf="expandedAccount?.accountId === account.accountId" class="account-details-expanded">
						<mat-tab-group class="details-tabs">
							<!-- Basic Details Tab -->
							<mat-tab label="Basic Details">
								<div class="tab-content">
									<div class="detail-row">
										<span class="detail-label">Account Name:</span>
										<span class="detail-value">{{ account.name }}</span>
									</div>
									<div class="detail-row">
										<span class="detail-label">Account Type:</span>
										<span class="detail-value">{{ account.type | titlecase }}</span>
									</div>
									<div class="detail-row">
										<span class="detail-label">Current Balance:</span>
										<span class="detail-value" [class]="account.balance >= 0 ? 'positive' : 'negative'">
											{{ account.balance | currency }}
										</span>
									</div>
									<div class="detail-row" *ngIf="account.description">
										<span class="detail-label">Description:</span>
										<span class="detail-value">{{ account.description }}</span>
									</div>
									<div class="detail-row" *ngIf="account.createdAt">
										<span class="detail-label">Created:</span>
										<span class="detail-value">{{ dateService.toDate(account.createdAt) | date:'shortDate' }}</span>
									</div>
								</div>
							</mat-tab>

							<!-- Loan Details Tab (only for loan accounts) -->
							<mat-tab label="Loan Details" *ngIf="isLoanAccount(account)">
								<div class="tab-content">
									<div class="detail-row">
										<span class="detail-label">Lender Name:</span>
										<span class="detail-value">{{ getLoanDetails(account)?.lenderName || 'N/A' }}</span>
									</div>
									<div class="detail-row">
										<span class="detail-label">Interest Rate:</span>
										<span class="detail-value">{{ getLoanDetails(account)?.interestRate }}%</span>
									</div>
									<div class="detail-row">
										<span class="detail-label">Monthly Interest:</span>
										<span class="detail-value interest-amount">{{ calculateMonthlyInterest(account) | currency }}</span>
									</div>
									<div class="detail-row">
										<span class="detail-label">Next Due Date:</span>
										<span class="detail-value">{{ getLoanDetails(account)?.nextDueDate | date:'fullDate' }}</span>
									</div>
									<div class="detail-row">
										<span class="detail-label">Remaining Balance:</span>
										<span class="detail-value">{{ getLoanDetails(account)?.remainingBalance | currency }}</span>
									</div>
									<div class="detail-row">
										<span class="detail-label">Monthly Payment:</span>
										<span class="detail-value">{{ getLoanDetails(account)?.monthlyPayment | currency }}</span>
									</div>
									<div class="detail-row" *ngIf="getLoanDetails(account)?.durationMonths">
										<span class="detail-label">Loan Term:</span>
										<span class="detail-value">{{ getLoanDetails(account)?.durationMonths }} months</span>
									</div>
								</div>
							</mat-tab>

							<!-- Transaction History Tab -->
							<mat-tab label="Recent Transactions">
								<div class="tab-content">
									<div class="no-transactions" *ngIf="!getRecentTransactions(account)?.length">
										<mat-icon>receipt_long</mat-icon>
										<p>No recent transactions</p>
									</div>
									<div class="transaction-list" *ngIf="getRecentTransactions(account)?.length">
										<div class="transaction-item" *ngFor="let transaction of getRecentTransactions(account)">
											<div class="transaction-info">
												<span class="transaction-description">{{ transaction.description }}</span>
												<span class="transaction-date">{{ transaction.date | date:'shortDate' }}</span>
											</div>
											<span class="transaction-amount" [class]="transaction.amount >= 0 ? 'positive' : 'negative'">
												{{ transaction.amount | currency }}
											</span>
										</div>
									</div>
								</div>
							</mat-tab>

							<!-- Statistics Tab -->
							<mat-tab label="Statistics">
								<div class="tab-content">
									<div class="detail-row">
										<span class="detail-label">Total Transactions:</span>
										<span class="detail-value">{{ getAccountStats(account)?.totalTransactions || 0 }}</span>
									</div>
									<div class="detail-row">
										<span class="detail-label">Total Deposits:</span>
										<span class="detail-value positive">{{ getAccountStats(account)?.totalDeposits | currency }}</span>
									</div>
									<div class="detail-row">
										<span class="detail-label">Total Withdrawals:</span>
										<span class="detail-value negative">{{ getAccountStats(account)?.totalWithdrawals | currency }}</span>
									</div>
									<div class="detail-row">
										<span class="detail-label">Average Transaction:</span>
										<span class="detail-value">{{ getAccountStats(account)?.averageTransaction | currency }}</span>
									</div>
									<div class="detail-row">
										<span class="detail-label">Largest Transaction:</span>
										<span class="detail-value">{{ getAccountStats(account)?.largestTransaction | currency }}</span>
									</div>
									<div class="detail-row">
										<span class="detail-label">This Month:</span>
										<span class="detail-value">{{ getAccountStats(account)?.thisMonth | currency }}</span>
									</div>
									<div class="detail-row">
										<span class="detail-label">Last Month:</span>
										<span class="detail-value">{{ getAccountStats(account)?.lastMonth | currency }}</span>
									</div>
								</div>
							</mat-tab>
						</mat-tab-group>
					</div>
				</div>
				}
			</div>
		</section>
	</div>
</div>
